// This is your Prisma schema file
// Learn more at: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships   GroupMember[]
  paidExpenses  Expense[]      @relation("ExpensePayer")
  expenseSplits ExpenseSplit[]
  settlementsFrom Settlement[] @relation("SettlementFrom")
  settlementsTo   Settlement[] @relation("SettlementTo")

  @@index([email])
}

model Group {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     GroupMember[]
  expenses    Expense[]
  settlements Settlement[]

  @@index([name])
}

model GroupMember {
  id        String   @id @default(uuid())
  userId    String
  groupId   String
  balance   Decimal  @default(0) // Positive = owed money, Negative = owes money
  joinedAt  DateTime @default(now())

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

model Expense {
  id          String    @id @default(uuid())
  groupId     String
  payerId     String
  amount      Decimal
  description String
  splitType   String    // EQUAL, EXACT, or PERCENTAGE
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  group  Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  payer  User           @relation("ExpensePayer", fields: [payerId], references: [id], onDelete: Cascade)
  splits ExpenseSplit[]

  @@index([groupId])
  @@index([payerId])
  @@index([createdAt])
}

// Stores resolved split amounts (not formulas) for immutable audit trail
model ExpenseSplit {
  id        String  @id @default(uuid())
  expenseId String
  userId    String
  amount    Decimal // Resolved amount this user owes

  // Relations
  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([expenseId, userId])
  @@index([expenseId])
  @@index([userId])
}

model Settlement {
  id        String   @id @default(uuid())
  groupId   String
  fromUserId String  // User who paid
  toUserId   String  // User who received
  amount    Decimal
  createdAt DateTime @default(now())

  // Relations
  group    Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  fromUser User  @relation("SettlementFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User  @relation("SettlementTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([createdAt])
}
